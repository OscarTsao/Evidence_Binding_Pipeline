name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest -q --tb=short

      - name: Run publication gate tests
        run: |
          pytest tests/test_publication_gate.py -v

  verify-checksums:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Verify paper bundle checksums
        run: |
          python scripts/verification/verify_checksums.py

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install linting tools
        run: |
          pip install ruff

      - name: Run ruff
        run: |
          ruff check src/ --ignore E501,F401 || true

  publication-gate:
    runs-on: ubuntu-latest
    needs: [test, verify-checksums]
    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          test -f LICENSE && echo "✓ LICENSE"
          test -f CITATION.cff && echo "✓ CITATION.cff"
          test -f README.md && echo "✓ README.md"
          test -f docs/DATA_AVAILABILITY.md && echo "✓ DATA_AVAILABILITY.md"
          test -f docs/ETHICS.md && echo "✓ ETHICS.md"
          test -f results/paper_bundle/v1.0/MANIFEST.md && echo "✓ MANIFEST.md"
          test -f results/paper_bundle/v1.0/metrics_master.json && echo "✓ metrics_master.json"
          test -f results/paper_bundle/v1.0/checksums.txt && echo "✓ checksums.txt"
          echo "All required files present!"

      - name: Verify paper bundle structure
        run: |
          echo "Checking paper bundle structure..."
          test -d results/paper_bundle/v1.0/figures && echo "✓ figures/ directory exists"
          ls results/paper_bundle/v1.0/figures/*.png | wc -l | xargs -I {} test {} -ge 1 && echo "✓ figures present"
          echo "Paper bundle structure verified!"
